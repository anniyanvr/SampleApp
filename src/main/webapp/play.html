<%@ page language="java" contentType="text/html; charset=UTF-8"
pageEncoding="UTF-8"%>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Ant Media Server</title>

<!-- 1. skin -->
<link rel="stylesheet"
	href="//releases.flowplayer.org/7.1.2/skin/skin.css">

<!-- 3. flowplayer -->
<script src="//releases.flowplayer.org/7.1.2/flowplayer.min.js"></script>

<script src="//releases.flowplayer.org/hlsjs/flowplayer.hlsjs.min.js"></script>

<script src="js/fetch.js"></script>
<script src="js/promise.min.js"></script>
</head>
<body>

	<div id="video-player" class="fp-slim"></div>

	<script>

	
	
	var name = "<%= request.getParameter("name") %>";
	
	var pAutoplay = "<%= request.getParameter("autoplay") %>";
	var autoPlay = false;
	if (pAutoplay == "true") {
		autoPlay = true;
	}
	
	
	
	//ask if vod file
	fetch("streams/"+ name +".mp4", {method:'HEAD'})
		.then(function(response){  
			
			if (response.status == 200) 
			{
				//yes it is a vod file, play it
				flowplayer("#video-player", {
					poster: "previews/" + name + ".png",
					autoplay: autoPlay,
				    ratio: 9/16,
				    clip: {
				      sources: [
				        { type: "video/mp4",
				          src: "streams/"+ name +".mp4" } 
				      ]
				    }
				  });
			}
			else {
				// there is no vod file, ask server
				fetch("rest/broadcast/get?id=" + name ).then(function(response) 
						{
							response.json().then(function (data) 
							{
						
								if (data.status == "created") {
									
									flowplayer("#video-player", {
										splash: "images/broadcast_not_started_tr.png",
									    ratio: 9/16,
									    clip: {
									      live: true,
									      sources: [
									        { type: "application/x-mpegurl",
									          src: "streams/"+ name +".m3u8" }
									      ]
									    }
									  });
								}
								else if (data.status == "broadcasting") {
									
									fetch("streams/"+ name +"_adaptive.m3u8", {method:'HEAD'})
										.then(function(response) 
										 {
											var videoSrc = "streams/"+ name +".m3u8";
										           
											if (response.status == 200) {
												videoSrc = "streams/" + name + "_adaptive.m3u8";
											}
											
											flowplayer("#video-player", {
												poster: "previews/" + name + ".png",
												autoplay: autoPlay,
											    ratio: 9/16,
											    clip: {
											      live: true,
											      sources: [
											        { type: "application/x-mpegurl",
											          src: videoSrc 
											        }  
											      ]
											    }
											  });
										});
									
									
								}
								else if (data.status == "finished") {
									flowplayer("#video-player", {
										poster: "previews/" + name + ".png",
										autoplay: autoPlay,
									    ratio: 9/16,
									    clip: {
									      sources: [
									        { type: "video/mp4",
									          src: "streams/"+ name +".mp4" }  
									      ]
									    }
									  });
								}
								else if (data.status == null) {
									// do nothing
								}
						}); // end of response.json
				}).catch(function(err) {
					console.log(err);
				});
			}
		 }).catch(function(err) { console.log(err); });

</script>

</body>
</html>